generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Alias types for P2P transfers
enum AliasType {
  EMAIL
  PHONE
  USERNAME
  RANDOM_KEY
}

// Recipient type for transfers (Individual P2P vs Micro Merchant)
enum RecipientType {
  INDIVIDUAL        // Standard P2P transfer (free)
  MICRO_MERCHANT    // Micro Merchant payment (fee-based)
  // MERCHANT       // Reserved for future NSIM integration
}

// Transfer type for categorization
enum TransferType {
  P2P                   // Standard peer-to-peer transfer
  MERCHANT              // Micro Merchant payment
  REFUND                // Refund of a previous transfer
  CONTRACT_SETTLEMENT   // ContractSim settlement payout
}

// Transfer status lifecycle
enum TransferStatus {
  PENDING           // Created, awaiting processing
  RESOLVING         // Looking up recipient
  RECIPIENT_NOT_FOUND
  DEBITING          // Withdrawing from sender
  DEBIT_FAILED
  CREDITING         // Depositing to recipient
  CREDIT_FAILED
  COMPLETED         // Successfully transferred
  CANCELLED         // Cancelled by sender
  EXPIRED           // Timed out
  REVERSED          // Reversed after completion
}

// User aliases for receiving transfers
model Alias {
  id              String    @id @default(uuid())
  type            AliasType
  value           String    // The actual alias value
  normalizedValue String    // Lowercase/E.164 normalized

  // Owner info (from BSIM)
  userId          String    // User's ID at their BSIM
  bsimId          String    // Which BSIM this user belongs to
  accountId       String?   // Preferred account for receiving

  // Status
  isVerified      Boolean   @default(false)
  isActive        Boolean   @default(true)
  isPrimary       Boolean   @default(false)

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  verifiedAt      DateTime?

  @@unique([type, normalizedValue])
  @@index([userId, bsimId])
  @@index([normalizedValue])
  @@map("aliases")
}

// P2P transfers between users
model Transfer {
  id                  String         @id @default(uuid())
  transferId          String         @unique // External transfer ID (p2p_xxx)

  // Sender info
  senderUserId        String
  senderBsimId        String
  senderAccountId     String
  senderAlias         String?        // Alias used to identify sender

  // Recipient info
  recipientAlias      String         // Alias used to find recipient
  recipientAliasType  AliasType
  recipientUserId     String?        // Resolved after lookup
  recipientBsimId     String?        // Resolved after lookup
  recipientAccountId  String?        // Resolved after lookup

  // Transfer details
  amount              Decimal        @db.Decimal(15, 2)
  currency            String         @default("CAD")
  description         String?

  // Transfer type categorization
  transferType        TransferType   @default(P2P)

  // Recipient type (Individual P2P or Micro Merchant)
  recipientType       RecipientType  @default(INDIVIDUAL)
  microMerchantId     String?        // Reference to MicroMerchant if recipientType is MICRO_MERCHANT

  // ContractSim settlement reference (for CONTRACT_SETTLEMENT transfers)
  contractId          String?        // ContractSim contract ID
  settlementId        String?        // Settlement request ID for linking back

  // Fee details (for Micro Merchant payments)
  feeAmount           Decimal?       @db.Decimal(15, 2)
  feeCollected        Boolean        @default(false)

  // Status tracking
  status              TransferStatus @default(PENDING)
  statusMessage       String?

  // BSIM transaction references
  debitTransactionId  String?        // Transaction ID at sender's BSIM
  creditTransactionId String?        // Transaction ID at recipient's BSIM

  // Orchestrator info
  orchestratorId      String?

  // Profile images (captured at transfer creation for history display)
  senderProfileImageUrl    String?   // Sender's profile image URL from WSIM
  recipientProfileImageUrl String?   // Recipient's profile image URL (WSIM for individuals, MicroMerchant for merchants)

  // Timestamps
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  completedAt         DateTime?
  expiresAt           DateTime?      // For pending transfers

  @@index([senderUserId, senderBsimId])
  @@index([recipientUserId, recipientBsimId])
  @@index([status])
  @@index([transferId])
  @@map("transfers")
}

// Registered orchestrators (mobile apps, web apps)
model Orchestrator {
  id                  String    @id @default(uuid())
  orchestratorId      String    @unique // External ID (orch_xxx)
  name                String
  type                String    // MOBILE_APP, WEB_APP, TERMINAL

  // Authentication
  apiKey              String    @unique
  apiKeyHash          String    // Hashed API key for validation
  webhookUrl          String?
  webhookSecret       String?

  // Permissions
  canEnrollUsers      Boolean   @default(true)
  canInitiateTransfers Boolean  @default(true)
  canViewTransfers    Boolean   @default(true)
  dailyTransferLimit  Decimal?  @db.Decimal(15, 2)
  perTransferLimit    Decimal?  @db.Decimal(15, 2)

  // Status
  isActive            Boolean   @default(true)

  // Timestamps
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@map("orchestrators")
}

// Connected BSIM instances
model BsimConnection {
  id                        String   @id @default(uuid())
  bsimId                    String   @unique // Identifier for this BSIM
  name                      String   // "Bank A", "Bank B"

  // Connection details
  baseUrl                   String   // https://bsim-a.example.com
  apiKey                    String   // API key for P2P operations

  // Open Banking endpoints
  authServerUrl             String   // For token validation
  openBankingUrl            String   // For payment initiation

  // Capabilities
  supportsPaymentInitiation Boolean  @default(false)
  supportsInstantTransfer   Boolean  @default(true)

  // Status
  isActive                  Boolean  @default(true)

  // Timestamps
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  @@map("bsim_connections")
}

// User enrollments (users enrolled in P2P via orchestrators)
model UserEnrollment {
  id               String    @id @default(uuid())

  // User identity (from BSIM)
  userId           String
  bsimId           String

  // Enrollment details
  orchestratorId   String
  enrolledAt       DateTime  @default(now())

  // Consent
  consentScopes    String[]  // What the user consented to
  consentExpiresAt DateTime?

  // Status
  isActive         Boolean   @default(true)

  @@unique([userId, bsimId, orchestratorId])
  @@map("user_enrollments")
}

// QR/NFC tokens for device-to-device transfers
model Token {
  id            String    @id @default(uuid())
  tokenId       String    @unique // External token ID (tok_xxx)
  type          String    // RECEIVE, SEND

  // Token payload
  aliasId       String?   // Associated alias
  userId        String    // Token creator
  bsimId        String
  amount        Decimal?  @db.Decimal(15, 2) // Optional pre-set amount
  currency      String    @default("CAD")
  description   String?

  // Recipient type for visual differentiation
  recipientType     RecipientType @default(INDIVIDUAL)
  microMerchantId   String?       // Reference to MicroMerchant if applicable

  // Status
  isUsed        Boolean   @default(false)
  usedAt        DateTime?
  usedByUserId  String?

  // Timestamps
  createdAt     DateTime  @default(now())
  expiresAt     DateTime  // Default 5 minutes

  @@index([tokenId])
  @@index([expiresAt])
  @@map("tokens")
}

// Discovery beacon context types
enum BeaconContext {
  P2P_RECEIVE       // Individual requesting payment
  MERCHANT_RECEIVE  // Merchant accepting payment
}

// BLE Discovery beacons for proximity-based recipient discovery
model DiscoveryBeacon {
  id            String        @id @default(uuid())

  // Token identification (32-bit split into major/minor for iBeacon)
  beaconToken   String        @unique @db.VarChar(8)  // Hex representation
  major         Int           // Upper 16 bits
  minor         Int           // Lower 16 bits

  // Owner identification (TransferSim composite key)
  userId        String        @db.VarChar(50)  // BSIM user ID
  bsimId        String        @db.VarChar(50)  // Bank identifier

  // Context
  context       BeaconContext
  metadata      Json?         // Optional context-specific data (amount, description)

  // Lifecycle
  createdAt     DateTime      @default(now())
  expiresAt     DateTime
  consumedAt    DateTime?     // Set when used for transfer

  @@unique([major, minor])
  @@index([beaconToken])
  @@index([expiresAt])
  @@index([userId, bsimId])
  @@map("discovery_beacons")
}

// Micro Merchant categories
enum MerchantCategory {
  RETAIL
  FOOD_AND_BEVERAGE
  SERVICES
  CRAFTS_AND_HANDMADE
  DIGITAL_GOODS
  OTHER
}

// Micro Merchant profiles - users who accept payments with business tracking
model MicroMerchant {
  id                  String           @id @default(uuid())
  merchantId          String           @unique // External ID (mm_xxx)

  // Owner info (linked to P2P user)
  userId              String
  bsimId              String

  // Business details
  merchantName        String           // Display name (e.g., "Sarah's Bakery")
  merchantCategory    MerchantCategory @default(OTHER)
  description         String?          // Brief description of business

  // Logo/branding (Phase 2)
  logoImageUrl        String?          // CDN URL for merchant logo
  logoImageKey        String?          // S3 key for deletion/replacement
  initialsColor       String?          // Background color for initials fallback

  // Receiving preferences
  receivingAliasId    String?          // Preferred alias for receiving
  receivingAccountId  String?          // Preferred account for deposits

  // Fee configuration (future: per-BSIM admin pricing)
  feePercentage       Decimal?         @db.Decimal(5, 4) // e.g., 0.0100 = 1%
  feeFlat             Decimal?         @db.Decimal(15, 2) // Flat fee amount

  // Stats (denormalized for dashboard performance)
  totalReceived       Decimal          @default(0) @db.Decimal(15, 2)
  totalTransactions   Int              @default(0)
  totalFees           Decimal          @default(0) @db.Decimal(15, 2)

  // Status
  isActive            Boolean          @default(true)

  // Timestamps
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  @@unique([userId, bsimId])
  @@index([merchantId])
  @@index([userId, bsimId])
  @@map("micro_merchants")
}

// Settlement status lifecycle
enum SettlementStatus {
  PENDING             // Settlement request received
  PROCESSING          // Transfer in progress
  COMPLETED           // Settlement successful
  FAILED              // Settlement failed
}

// ContractSim settlement requests - for idempotency and tracking
model Settlement {
  id                  String            @id @default(uuid())
  settlementId        String            @unique  // External ID (stl_xxx)

  // Idempotency
  idempotencyKey      String            @unique  // From Idempotency-Key header

  // Contract reference
  contractId          String            // ContractSim contract ID

  // Settlement details
  settlementType      String            // 'winner_payout', 'refund', 'partial', 'dispute_resolution'

  // Source (loser/escrow)
  fromWalletId        String            // WSIM wallet ID (e.g., "WLLT-ABC123")
  fromBsimId          String            // Bank identifier
  fromEscrowId        String?           // BSIM escrow hold ID

  // Destination (winner)
  toWalletId          String            // WSIM wallet ID
  toBsimId            String            // Bank identifier

  // Amount
  amount              Decimal           @db.Decimal(15, 2)
  currency            String            @default("CAD")

  // Contract metadata (stored for audit/display)
  metadata            Json?             // { contractTitle, originalStake, winnings, etc. }

  // Status
  status              SettlementStatus  @default(PENDING)
  statusMessage       String?
  errorCode           String?           // Error code if failed

  // Linked transfer (created when settlement is processed)
  transferId          String?           // Reference to Transfer record

  // Timestamps
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  completedAt         DateTime?

  @@index([contractId])
  @@index([status])
  @@index([idempotencyKey])
  @@map("settlements")
}
